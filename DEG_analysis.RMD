---
title: "Differential Gene Expression Analysis in Fundulus heteroclitus"
author: "Mathia Colwell"
output: html_document
---
## RNA-seq quantification

RNA-seq libraries were aligned to the Kings Creek Fundulus heteroclitus genome using
STAR, and transcript abundance was quantified using StringTie. Expression values
were summarized as transcripts per million (TPM). Log2-normalized expression values
were calculated for downstream comparisons.

```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)
```

# TPM matrix: rows = genes, columns = samples

```{r}
tpm_mat <- tibble(
  gene_name = paste0("gene_", 1:1000),
  KCERSE   = runif(1000, 0, 100),
  KCClean  = runif(1000, 0, 100),
  RPERSE   = runif(1000, 0, 100),
  RPClean  = runif(1000, 0, 100)
) %>%
  column_to_rownames("gene_name")

# Log2-normalized expression matrix
log2_mat <- log2(tpm_mat + 1)
```
## Differential expression definition
Differentially expressed genes (DEGs) were identified usign a custom, threshold-based
approach due to our sample size (10 pooled embryos per sample sequenced). For each comparison, 
genes were required to meet the following criteria: 
- Mean TPM >1.0 in at least one condition 
- Absolute log2 fold change > 1

This approach was used to focus on differential expression and to maintain consistency
across comparisons.

# DEG Function
```{r}
compute_deg <- function(mat, groupA, groupB, groupA_name, groupB_name) {

  meanA <- rowMeans(mat[, groupA, drop = FALSE])
  meanB <- rowMeans(mat[, groupB, drop = FALSE])

  log2FC <- meanA - meanB

  deg_tbl <- tibble(
    gene = rownames(mat),
    mean_LOG2FC = log2FC,
    mean_groupA_TPM = rowMeans(tpm_mat[, groupA, drop = FALSE]),
    mean_groupB_TPM = rowMeans(tpm_mat[, groupB, drop = FALSE])
  )

  expressed <- deg_tbl$mean_groupA_TPM > 1 | deg_tbl$mean_groupB_TPM > 1

  deg_tbl %>%
    mutate(
      DEG_up   = expressed & mean_LOG2FC >  1,
      DEG_down = expressed & mean_LOG2FC < -1
    )
}
```

## Run comparisons of interest (KCClean vs KCERSE and RPClean vs RPERSE as example)
```{r}
deg_KCERSE_vs_KCClean <- compute_deg(
  log2_mat,
  groupA = "KCERSE",
  groupB = "KCClean",
  "KCERSE",
  "KCClean"
)

deg_RPERSE_vs_RPClean <- compute_deg(
  log2_mat,
  groupA = "RPERSE",
  groupB = "RPClean",
  "RPERSE",
  "RPClean"
)
```

## Summary statistics and overlap 
```{r}

summarize_deg <- function(df) {
  tibble(
    total_genes = nrow(df),
    upregulated = sum(df$DEG_up),
    downregulated = sum(df$DEG_down)
  )
}

bind_rows(
  KCERSE_vs_KCClean = summarize_deg(deg_KCERSE_vs_KCClean),
  RPERSE_vs_RPClean = summarize_deg(deg_RPERSE_vs_RPClean),
  .id = "comparison"
)

deg_lists <- list(
  KCERSE_vs_KCClean = deg_KCERSE_vs_KCClean$gene[deg_KCERSE_vs_KCClean$DEG_up | deg_KCERSE_vs_KCClean$DEG_down],
  RPERSE_vs_RPClean = deg_RPERSE_vs_RPClean$gene[deg_RPERSE_vs_RPClean$DEG_up | deg_RPERSE_vs_RPClean$DEG_down]
)

length(intersect(
  deg_lists$KCERSE_vs_KCClean,
  deg_lists$RPERSE_vs_RPClean
))

```
